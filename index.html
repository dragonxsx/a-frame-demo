<!DOCTYPE html>
<html>
<head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script>THREEx.ArToolkitContext.baseURL = 'https://jeromeetienne.github.io/AR.js/three.js/'</script>
    <script src="main.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css"/>
    <script>
        function deviceMotionListener(event) {
            var x1 = event.accelerationIncludingGravity.x;
            var y1 = event.accelerationIncludingGravity.y;
            var z1 = event.accelerationIncludingGravity.z;			
            document.querySelector('#x1').innerText = x1;
            document.querySelector('#y1').innerText = y1;
            document.querySelector('#z1').innerText = z1;

            var x2 = event.acceleration.x;
            var y2 = event.acceleration.y;
            var z2 = event.acceleration.z;
            document.querySelector('#x2').innerText = x2;
            document.querySelector('#y2').innerText = y2;
            document.querySelector('#z2').innerText = z2;

            var deviceGravity = calHeightByAcceleration(x1-x2, y1-y2, z1-z2);
            gravity.innerText = deviceGravity;

            // Calculate height: http://www.citycollegiate.com/gravitation_XId.htm
            // g/g' = 1 - 2h/Re

            var Re = 6378160;
            var g = 9.806474455261554;
            var deviceHeight = (g-deviceGravity)*Re/(2*g);
            device_height.innerText = deviceHeight;
        }

        function deviceOrientationListener(event) {
            var alpha = event.alpha;
            var beta = event.beta;
            var gamma = event.gamma;
            document.querySelector('#alpha').innerText = alpha;
            document.querySelector('#beta').innerText = beta;
            document.querySelector('#gamma').innerText = gamma;
        }

        function calHeightByAcceleration(x,y,z){
            var sqrt = Number((x * x) + (y * y) + (z * z));
            var gravity = Math.sqrt(sqrt);
            return gravity;
        }

        // Add a event listener for tracking camera's position and rotation
        window.onload = function () {

            var camera = document.getElementById('camera');

            camera.addEventListener('componentchanged', function (evt) {
                switch (evt.detail.name) {
                    case 'rotation':
                        //console.log('camera rotation changed', evt.detail.newData);
                        var compassRotation = camera.components['compass-rotation'];
                        var lookControls = camera.components['look-controls'];
                        //document.querySelector('#compass_heading').innerText = compassRotation.heading;

                        camera_angle.innerText = evt.detail.newData.y;
                        if (lookControls) {
                            yaw_angle.innerText = THREE.Math.radToDeg(lookControls.yawObject.rotation.y);
                        }

                        //if (compassRotation) {
                        //    compass_heading.innerText = compassRotation.heading;
                        //    device_orientation.innerText = compassRotation.currentOrientation;     
                        //}
                        break;
                    case 'position':
                        //console.log('camera position changed', evt.detail.newData);
                        var gpsPosition = camera.components['gps-position'];
                        camera_p_x.innerText = evt.detail.newData.x;
                        camera_p_z.innerText = evt.detail.newData.z;
                        if (gpsPosition) {
                            if (gpsPosition.coords) {
                                crd_longitude.innerText = gpsPosition.coords.longitude;
                                crd_latitude.innerText = gpsPosition.coords.latitude;
                                crd_altitude.innerText = gpsPosition.coords.altitude;
                                crd_accuracy.innerText = gpsPosition.coords.accuracy;
                            }
                            if (gpsPosition.zeroCoords) {
                                zero_crd_longitude.innerText = gpsPosition.zeroCoords.longitude;
                                zero_crd_latitude.innerText = gpsPosition.zeroCoords.latitude;
                                zero_crd_altitude.innerText = gpsPosition.zeroCoords.altitude;
                            }
                        }

                        break;
                }
            });
    
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", deviceOrientationListener);
              } else {
                alert("Sorry, your browser doesn't support Device Orientation");
              }
    
            if('ondevicemotion' in window) {
                 window.addEventListener('devicemotion', deviceMotionListener);
            }
        };
    </script>
</head>

<body>

    <div id="tracking-panel">
        <div>
            coords:
            <span id="crd_longitude"></span>,
            <span id="crd_latitude"></span>,
            <span id="crd_altitude"></span><br>

            (zero coords:
            <span id="zero_crd_longitude"></span>,
            <span id="zero_crd_latitude"></span>,
            <span id="zero_crd_altitude"></span>)<br>

            GPS accuracy:
            <span id="crd_accuracy"></span><br>

            Acceleration Including Gravity:<br>
            x: <span id="x1"></span><br>
            y: <span id="y1"></span><br>
            z: <span id="z1"></span><br>
    
            Acceleration:<br>
            x: <span id="x2"></span><br>
            y: <span id="y2"></span><br>
            z: <span id="z2"></span><br>
    
            Gyroscope:<br>
            alpha: <span id="alpha"></span><br>
            beta: <span id="beta"></span><br>
            gamma: <span id="gamma"></span><br>

            compass heading:
                <span id="compass_heading"><br>
        </div>
        <div>
            camera coords:
            <span id="camera_p_x"></span>,
            <span id="camera_p_z"></span><br>
        </div>
        <div>
            camera angle:
            <span id="camera_angle"></span>, yaw angle:
            <span id="yaw_angle"></span><br>
        </div>
        <div>
            Device device orientation:
            <span id="device_orientation"></span><br>
            
            Gravity: 
            <span id="gravity"></span> Height: <span id="device_height"></span>
        </div>
    </div>

    <a-scene embedded arjs="sourceType: webcam;">
        <a-camera id="camera" user-height="1.6" gps-position compass-rotation camera-logger>
        </a-camera>

        <a-entity road>
        </a-entity>
    </a-scene>

    <script>
            
    </script>
</body>

</html>